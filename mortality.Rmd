---
title: "U.S. State Mortality Counts and Estimates for 2020 (Revised)"
author:
- name: Kieran Healy
  url: https://kieranhealy.org
  affiliation: Duke University
  affiliation_url: https://sociology.duke.edu
date: "`r Sys.Date()`"
description: |
  Looking at CDC Data on Mortality.
toc: true  
output:
  html_document:
    highlight: tango    
  pdf_document:
    template: ~/.pandoc/templates/rmd-latex.template  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set()
```

```{r}
library(tidyverse)
library(janitor)

## https://kjhealy.github.io/socviz
library(socviz)

###-------------------------------------------------
### Not needed to draw the graphs
library(showtext)
showtext_auto()

library(myriad)
import_myriad_semi_ttf()

theme_set(theme_myriad_new())
###-------------------------------------------------


library(patchwork)

```

```{r}
## https://kjhealy.github.io/covdata
library(covdata)
```


```{r}

states <- nchs_wdc %>% 
  select(jurisdiction) %>% 
  unique() %>%
  mutate(fname = tolower(paste0("figures/", jurisdiction, "_patch")), 
         fname = stringr::str_replace_all(fname, " ", "_"))

```

# Overview

Graphs of current CDC data on weekly mortality counts for the United States nationally, by state, and for New York City. Graphs show (1) Overall weekly all-cause death counts, in comparison to the same weeks in 2015-2019, (2) COVID-19 attributed deaths (multiple cause) for 2020, (3) Weekly death counts by selected cause groups, in comparison to the same weeks in 2014-2018, and (3) Percentage difference in mortality between each week in 2020 and the average of the same week between 2014 and 2018. 

Data are from the Centers for Disease Control / National Center for Health Statistics, packaged in `covdata` for R: <https://kjhealy.github.io/covdata>.


# Averages 2015-2019

- Using 2015-2019 to follow the CDC in `nchs_wdc`.

```{r}

dat <- nchs_wdc %>%
  filter(year > 2014) %>%
  mutate(month_label = lubridate::month(week_ending_date, label = TRUE))

average_deaths <- nchs_wdc %>% 
  filter(year %in% c(2015:2019)) %>%
  group_by(jurisdiction, week, cause) %>%
  summarize(average_wk_deaths = mean(n, na.rm = TRUE)) 

df <- left_join(dat, average_deaths) %>%
  select(everything(), n, average_wk_deaths) %>%
  mutate(n_diff = n - average_wk_deaths, 
         pct_diff = (n_diff / n)*100) %>%
  filter(cause %nin% c("Natural Causes", "Other"))
```


```{r}
## Choose how many red-line wks
nwks <- 37

season_label <- tibble(wk_num = lubridate::epiweek(as.Date(c("2020-03-01",
                                     "2020-06-01",
                                     "2020-09-01",
                                     "2020-12-01"))),
                    season_lab = c("Spring", "Summer", "Autumn", "Winter"))

order_panels <- function(st = state, ...) {
  df %>% 
  filter(jurisdiction %in% st, cause != "All Cause") %>%
  group_by(cause) %>% 
  summarize(deaths = sum(n, na.rm = TRUE), 
            .groups = "drop") %>%
  mutate(cause_rank = rank(-deaths), 
         o = order(cause_rank),
         cause_ord = factor(cause, levels = cause[o], ordered = TRUE)) %>%
  select(cause, cause_ord)
}

patch_state_count <- function(state) {

  out <- df %>% 
  filter(jurisdiction %in% state, cause == "All Cause") %>%
  group_by(year, week) %>% 
  mutate(yr_ind = year %in% 2020) %>%
  filter(!(year == 2020 & week > nwks)) %>%
  ggplot(aes(x = week, y = n, color = yr_ind, group = year)) + 
  geom_line(size = 0.9) + 
  scale_color_manual(values = c("gray70", "firebrick"), labels = c("2015-2019", "2020")) +
  scale_x_continuous(breaks = season_label$wk_num, labels = season_label$season_lab) +      
  scale_y_continuous(labels = scales::comma) +
  labs(x = NULL, 
       y = "Total Deaths", 
       color = "Years",
       title = "Weekly recorded deaths from all causes", 
       subtitle = paste0("2020 data are for Weeks 1 to ", nwks, ". Raw Counts.")) 
  
  out

}

patch_state_cause <- function(state, nc = 2) {

panel_ordering <- order_panels(st = state)
  
out <- df %>% 
  filter(jurisdiction == state, 
         cause %nin% c("All Cause", "COVID-19 Multiple cause", "COVID-19 Underlying")) %>%
  group_by(cause, year, week) %>% 
  summarize(deaths = sum(n, na.rm = TRUE), .groups = "drop") %>%
  mutate(yr_ind = year %in% 2020) %>%
  filter(!(year == 2020 & week > nwks)) %>%
  left_join(panel_ordering, by = "cause") %>%
  ggplot(aes(x = week, y = deaths, color = yr_ind)) + 
  geom_line(size = 0.9, mapping = aes(group = year)) + 
  scale_color_manual(values = c("gray70", "firebrick"), labels = c("2015-2019", "2020")) +
  scale_x_continuous(breaks = c(1, 10, 20, 30, 40, 50), labels = as.character(c(1, 10, 20, 30, 40, 50))) + 
  scale_y_continuous(labels = scales::comma) +
  facet_wrap(~ cause_ord, ncol = nc, labeller = label_wrap_gen(25)) + 
  labs(x = "Week of the Year", 
       y = "Total Deaths", 
       color = "Years",
       title = "Weekly deaths from selected causes", 
       subtitle = "Panels ordered by number of deaths. Raw Counts.") 

out
}

patch_state_percent <- function(state, nc = 2){
  
  panel_ordering <- order_panels(st = state)

  out <- df %>% 
  filter(jurisdiction %in% state, 
         year == 2020, 
         cause %nin% c("All Cause", "COVID-19 Multiple cause", 
                                                "COVID-19 Underlying"), !is.na(pct_diff)) %>%
  group_by(week) %>% 
  filter(!(week > nwks)) %>%
  mutate(ov_un = pct_diff > 0) %>%
  left_join(panel_ordering, by = "cause") %>%
  ggplot(aes(x = week, y = pct_diff/100, fill = ov_un)) + 
  geom_col() + 
  scale_x_continuous(breaks = c(1, seq(10, nwks, 10)), labels = as.character(c(1, seq(10, nwks, 10)))) + 
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values = c("gray40", "firebrick")) +
  guides(fill = FALSE) + 
  facet_wrap(~ cause_ord, ncol = nc, labeller = label_wrap_gen(25)) + 
  labs(x = "Week of the Year", 
       y = "Percent", 
       title = "Percent difference from 2015-2019 average",
       subtitle = paste0("Data for weeks 1 to ", nwks, " only.")) 

  out
}

patch_state_covid <- function(state) {

  out <- df %>% 
  filter(jurisdiction %in% state, cause %in% c("COVID-19 Multiple cause")) %>%
  group_by(year, week) %>% 
  mutate(yr_ind = year %in% 2020) %>%
  filter(year == 2020) %>%
  ggplot(aes(x = week, y = n, group = year)) + 
  geom_col(fill = "gray30") + 
  scale_x_continuous(breaks = c(1, 10, 20, 30, 40, 50), 
                     labels = as.character(c(1, 10, 20, 30, 40, 50)), 
                     limits = c(1, 52)) + 
  scale_y_continuous(labels = scales::comma) + 
  labs(x = "Week of the Year", 
       y = "Total Deaths", 
       color = "Years",
       subtitle = "Raw counts.",
       title = "Weekly deaths recorded as COVID-19 (Multiple cause)") 
  
  out

}

make_patchplot <- function(state){
  
if(state == "New York")  {
  state_title <- paste(state, "(Excluding New York City)")
} else 
  {
  state_title <- state
}

timestamp <-  lubridate::stamp("March 1, 1999", "%B %d, %Y")(lubridate::ymd(Sys.Date()))   
  


(patch_state_count(state) + theme(plot.margin = unit(c(5,0,0,0), "pt"))) / patch_state_covid(state) / (patch_state_cause(state) + (patch_state_percent(state))) +  
    plot_layout(heights = c(2, 0.5, 4), guides = 'collect') + 
  plot_annotation(
  title = state_title,
  caption = paste0("Graph: @kjhealy Data: CDC. This graph was made on ", timestamp, "."), 
  theme = theme(plot.title = element_text(size = rel(2), hjust = 0, face = "plain")))
}
```

```{r draw-everything, eval = FALSE}

out_patch <- states %>% 
  mutate(patch_plot = map(jurisdiction, make_patchplot))

walk2(paste0(out_patch$fname, ".png"), 
     out_patch$patch_plot, ggsave, height = 16, width = 9, dpi = 200)

walk2(paste0(out_patch$fname[9:54], ".pdf"), 
     out_patch$patch_plot[9:54], ggsave, height = 16, width = 9)




```

```{r}

us_average_deaths <- nchs_wdc %>% 
  filter(year %in% c(2015:2019)) %>%
  group_by(week, cause) %>%
  summarize(average_wk_deaths = mean(n, na.rm = TRUE)) %>%
  ungroup()

us_total <- nchs_wdc %>%
  group_by(year, week, cause) %>%
  summarize(n = sum(n, na.rm = TRUE)) %>%
  ungroup()

us_all <- left_join(us_total, us_average_deaths) %>%
  filter(year %in% c(2015:2019)) %>%
  select(everything(), n, average_wk_deaths) %>%
  mutate(n_diff = n - average_wk_deaths, 
         pct_diff = (n_diff / n)*100)
  
us <- make_patchplot("United States")

ggsave("figures/usa_patch.pdf", us, height = 16, width = 9)
ggsave("figures/usa_patch.png", us, height = 16, width = 9, dpi = 200)

```

```{r, echo = FALSE, fig.align = "center", fig.show="asis", out.width="90%"}
#include_graphics("figures/usa_patch.pdf")
```


```{r, echo = FALSE, fig.align = "center", fig.show="asis", out.width="90%"}
#patchplots <- list.files("figures/", pattern = ".pdf", full.names = TRUE)
#include_graphics(patchplots)
```

## Comparative mortality data

```{r}

rate_rank <- stmf %>%
  filter(sex == "b", year > 2014 & year < 2020) %>%
  group_by(country_code) %>%
  summarize(mean_rate = mean(rate_total, na.rm = TRUE)) %>% 
  mutate(rate_rank = rank(mean_rate))
  

rate_max_rank <- stmf %>%
  filter(sex == "b", year == 2020) %>%
  group_by(country_code) %>%
  summarize(covid_max = max(rate_total, na.rm = TRUE)) %>% 
  mutate(covid_max_rank = rank(covid_max))

out <- stmf %>%
  filter(sex == "b", year > 2014, 
         country_code %in% c("AUT", "BEL", "CHE", "DEUTNP", "DNK", "ESP", "FIN",
                             "FRATNP", "GBR_SCO", "GBRTENW", "GRC", "HUN",
                             "ITA", "LUX", "POL", "NLD", "NOR", "PRT", "SWE", "USA")) %>%
  filter(!(year == 2020 & week > 30)) %>%
  group_by(cname, year, week) %>%
  mutate(yr_ind = year %in% 2020) %>%
  slice(1) %>% 
  left_join(rate_rank, by = "country_code") %>% 
  left_join(rate_max_rank, by = "country_code") %>% 
  ggplot(aes(x = week, y = rate_total, color = yr_ind, group = year)) + 
  scale_color_manual(values = c("gray70", "firebrick"), labels = c("2015-2019", "2020")) +
  scale_x_continuous(limits = c(1, 52),  
                     breaks = c(1, seq(10, 50, 10)), 
                     labels = as.character(c(1, seq(10, 50, 10)))) + 
  facet_wrap(~ reorder(cname, rate_rank, na.rm = TRUE), ncol = 10) +
  geom_line(size = 0.9) + 
  guides(color = guide_legend(override.aes = list(size = 3))) + 
  labs(x = "Week of the Year", 
       y = "Total Death Rate", 
       color = "Year",
       title = "Overall Weekly Death Rates",
       subtitle = "Comparing 2020 with 2015-2019 across selected countries. Countries are shown top\nleft to bottom right ordered from lowest to highest average mortality rate in 2015-2019.",
       caption = "Data for 2020 is for Weeks 1 to 30. Graph: @kjhealy. Data: Human Mortality Database, mortality.org") + 
  theme(legend.position = "top", 
        plot.title = element_text(size = rel(3.6)),
        plot.subtitle = element_text(size = rel(1.25)),
        strip.text = element_text(size = rel(1.4), hjust = 0),
        legend.text = element_text(size = rel(1.1)), 
        legend.title = element_text(size = rel(1.1)))


ggsave("figures/national_mortality_rates.pdf", out, height = 16, width = 13)
ggsave("figures/national_mortality_rates_wide.png", out, height = 10, width = 20)


```


```{r}

df %>% 
  filter(jurisdiction == "United States", year == 2020) %>%
  summarize(wk = max(week))
  group_by(year, cause) %>%
  summarize(tot = sum(n)) %>%
  summarize(overall = sum(tot))

df %>% 
  filter(jurisdiction == "United States", cause == "All Cause", year == 2020) %>%
  group_by(year, cause) %>%
  summarize(tot = sum(n)) %>%
  summarize(overall = sum(tot))



```


```{r}
out <- patch_state_percent("United States", nc = 5)
ggsave(filename = "figures/usa_pct_wide.pdf", height = 4.5, width = 8)


```

```{r}

start_week <- 9
end_week <- 34

df_yr <- nchs_wdc %>%
#  filter(jurisdiction == "United States") %>% 
  filter(year > 2014,
         week >= start_week & 
         week <= end_week) %>% 
  group_by(jurisdiction, cause, year) %>%
  summarize(period_deaths = sum(n, na.rm = TRUE)) 

baseline_deaths <- nchs_wdc %>% 
  #filter(jurisdiction == "United States") %>% 
  filter(year %in% c(2015:2019),
         week >= start_week & 
         week <= end_week) %>%
  group_by(jurisdiction, year, cause) %>%
  summarize(total_n = sum(n, na.rm = TRUE)) %>%
  group_by(jurisdiction, cause) %>%
  summarize(baseline = mean(total_n, na.rm = TRUE), 
            baseline_sd = sd(total_n, na.rm = TRUE)) 

df_excess <- left_join(df_yr, baseline_deaths) %>%
  mutate(excess = period_deaths - baseline, 
         pct_excess = (excess / period_deaths)*100, 
         pct_sd = (baseline_sd/baseline)*100) %>%
  rename(deaths = period_deaths)

jurs <- c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", 
          "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", 
          "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", 
          "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", 
          "NY", "NYC", "NC", "ND", "OH", "OK", "OR", "PA", 
          "PR", "RI", "SC", "SD", "TN", "TX", "USA", "UT", "VT", 
          "VA", "WA", "WV", "WI", "WY")

df_overlays <- as_tibble(data.frame(
  state = unique(df_excess$jurisdiction), 
  jurs = jurs, 
  x = 0.5, y = 0.5)) %>% 
  mutate(fname = tolower(paste0("figures/", state, "_overlay")), 
         fname = stringr::str_replace_all(fname, " ", "_"))


abbr_plot <- function(x, y, lab){
  ggplot(mapping = aes(x = x, y = y, label = lab)) + 
    annotate("rect", xmin = 0, xmax = 1, ymin = 0, ymax = 1, 
             fill = "red", alpha = 0.2) + 
    geom_text(fontface = "bold", size = 5) +
    theme_void() + 
    theme(rect = element_rect(fill = "transparent", 
                              color = "transparent"))
}

df_overlays <- df_overlays %>% 
  mutate(overlay = pmap(list(x = x, y = y, lab = jurs), abbr_plot))

df_overlays$overlay[4]

walk2(paste0(df_overlays$fname, ".png"),
      df_overlays$overlay, 
      ggsave, 
      height = 0.5, 
      width = 1, 
      dpi = 300)

```


